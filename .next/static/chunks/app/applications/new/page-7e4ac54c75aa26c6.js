(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[58],{8700:function(e,t,r){Promise.resolve().then(r.bind(r,2406))},2406:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return i}});var s=r(7437),a=r(2265),o=r(9376),l=r(6319),n=r(9064);function i(){let e=(0,o.useRouter)(),[t,r]=(0,a.useState)([]),[i,c]=(0,a.useState)(!1),[d,m]=(0,a.useState)({title:"",type:"expense",amount:"",description:"",categoryId:"",expenseTime:"",source:"",reason:"",customCategory:""}),[u,x]=(0,a.useState)([]);(0,a.useEffect)(()=>{h()},[]);let h=async()=>{try{let e=localStorage.getItem("auth-token"),t=await fetch("/api/admin/categories",{headers:{Authorization:"Bearer ".concat(e)}}),s=await t.json();s.success&&r(s.data)}catch(e){console.error("Failed to fetch categories:",e)}},p=e=>{let{name:t,value:r,type:s}=e.target;m(e=>({...e,[t]:"number"===s?""===r?"":Number(r):r}))},g=e=>{x(t=>t.filter((t,r)=>r!==e))},b=async()=>{let e=[];for(let t of u){let r=new FormData;r.append("file",t);try{let t=localStorage.getItem("auth-token"),s=await fetch("/api/upload",{method:"POST",headers:{Authorization:"Bearer ".concat(t)},body:r}),a=await s.json();a.success&&e.push({url:a.data.url,name:a.data.name,size:a.data.size})}catch(e){n.Am.error("上传文件 ".concat(t.name," 失败"))}}return e},y=async t=>{t.preventDefault(),c(!0);try{if(!d.title||!d.amount||!d.description){n.Am.error("请填写必填字段"),c(!1);return}if("expense"===d.type&&!d.expenseTime){n.Am.error("支出申请必须填写支出时间"),c(!1);return}if("expense"===d.type&&!d.reason){n.Am.error("支出申请必须填写支出原因"),c(!1);return}if("income"===d.type&&(!d.source||!d.reason)){n.Am.error("收入申请必须填写来源和原因"),c(!1);return}if("expense"===d.type&&0===u.length){n.Am.error("支出申请必须上传至少1张凭证图片"),c(!1);return}if(u.length>5){n.Am.error("最多只能上传5张凭证图片"),c(!1);return}let t=d.categoryId;if("expense"===d.type&&d.customCategory&&d.customCategory.trim())try{let e=localStorage.getItem("auth-token"),r=await fetch("/api/admin/categories",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(e)},body:JSON.stringify({name:d.customCategory.trim(),description:"用户自定义分类"})}),s=await r.json();s.success&&(t=s.data.id.toString(),n.Am.success("已创建新分类: ".concat(d.customCategory.trim())))}catch(e){n.Am.error("创建自定义分类失败"),c(!1);return}let r=[];u.length>0&&(r=await b());let s={title:d.title,type:d.type,amount:Number(d.amount),description:d.description,categoryId:t?Number(t):void 0,expenseTime:d.expenseTime||void 0,source:d.source||void 0,reason:d.reason||void 0,proofImages:r},a=localStorage.getItem("auth-token"),o=await fetch("/api/applications",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(a)},body:JSON.stringify(s)}),l=await o.json();l.success?(n.Am.success("申请提交成功"),e.push("/")):n.Am.error(l.message)}catch(e){n.Am.error("提交申请失败")}finally{c(!1)}};return(0,s.jsx)(l.Z,{children:(0,s.jsx)("div",{className:"max-w-2xl mx-auto py-6 px-4 sm:px-0",children:(0,s.jsxs)("div",{className:"bg-white shadow rounded-lg p-6",children:[(0,s.jsx)("h1",{className:"text-2xl font-bold text-gray-900 mb-6",children:"新建申请"}),(0,s.jsxs)("form",{onSubmit:y,className:"space-y-6",children:[(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{htmlFor:"title",className:"block text-sm font-medium text-gray-700",children:"标题 *"}),(0,s.jsx)("input",{type:"text",id:"title",name:"title",value:d.title,onChange:p,className:"mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500",placeholder:"请输入申请标题",required:!0})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{htmlFor:"type",className:"block text-sm font-medium text-gray-700",children:"类型 *"}),(0,s.jsxs)("select",{id:"type",name:"type",value:d.type,onChange:p,className:"mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500",required:!0,children:[(0,s.jsx)("option",{value:"expense",children:"支出"}),(0,s.jsx)("option",{value:"income",children:"收入"})]})]})]}),(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{htmlFor:"amount",className:"block text-sm font-medium text-gray-700",children:"金额 (元) *"}),(0,s.jsx)("input",{type:"number",id:"amount",name:"amount",value:d.amount,onChange:p,step:"0.01",min:"0",className:"mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500",placeholder:"请输入金额",required:!0})]}),"expense"===d.type&&(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{htmlFor:"expenseTime",className:"block text-sm font-medium text-gray-700",children:"支出时间 *"}),(0,s.jsx)("input",{type:"datetime-local",id:"expenseTime",name:"expenseTime",value:d.expenseTime,onChange:p,className:"mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500",required:!0})]})]}),"expense"===d.type&&(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{htmlFor:"categoryId",className:"block text-sm font-medium text-gray-700",children:"支出分类"}),(0,s.jsxs)("div",{className:"mt-1 flex space-x-2",children:[(0,s.jsxs)("select",{id:"categoryId",name:"categoryId",value:d.categoryId,onChange:p,className:"flex-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500",children:[(0,s.jsx)("option",{value:"",children:"选择现有分类"}),t.map(e=>(0,s.jsx)("option",{value:e.id,children:e.name},e.id))]}),(0,s.jsx)("input",{type:"text",name:"customCategory",value:d.customCategory,onChange:p,placeholder:"或输入新分类",className:"flex-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"})]})]}),"income"===d.type&&(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{htmlFor:"source",className:"block text-sm font-medium text-gray-700",children:"收入来源 *"}),(0,s.jsx)("input",{type:"text",id:"source",name:"source",value:d.source,onChange:p,className:"mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500",placeholder:"请输入收入来源",required:!0})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{htmlFor:"description",className:"block text-sm font-medium text-gray-700",children:"描述 *"}),(0,s.jsx)("textarea",{id:"description",name:"description",value:d.description,onChange:p,rows:3,className:"mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500",placeholder:"请输入详细描述",required:!0})]}),(0,s.jsxs)("div",{children:[(0,s.jsxs)("label",{htmlFor:"reason",className:"block text-sm font-medium text-gray-700",children:["income"===d.type?"收入原因":"支出原因"," *"]}),(0,s.jsx)("textarea",{id:"reason",name:"reason",value:d.reason,onChange:p,rows:3,className:"mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500",placeholder:"请输入具体原因",required:!0})]}),"expense"===d.type&&(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"凭证图片 * (支出申请必须上传1-5张)"}),(0,s.jsxs)("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-6",children:[(0,s.jsxs)("div",{className:"text-center",children:[(0,s.jsx)("svg",{className:"mx-auto h-12 w-12 text-gray-400",stroke:"currentColor",fill:"none",viewBox:"0 0 48 48",children:(0,s.jsx)("path",{d:"M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"})}),(0,s.jsx)("input",{type:"file",multiple:!0,accept:"image/*",onChange:e=>{let t=Array.from(e.target.files||[]);x(e=>{let r=[...e,...t];return r.length>5?(n.Am.error("最多只能上传5张凭证图片"),e.slice(0,5)):r})},className:"hidden",id:"file-upload"}),(0,s.jsx)("label",{htmlFor:"file-upload",className:"cursor-pointer font-medium text-blue-600 hover:text-blue-500",children:"点击上传图片"}),(0,s.jsx)("p",{className:"mt-1 text-xs text-gray-500",children:"PNG, JPG, GIF up to 10MB each (最多5张，支出申请至少1张)"})]}),u.length>0&&(0,s.jsxs)("div",{className:"mt-4",children:[(0,s.jsxs)("div",{className:"text-sm text-gray-600 mb-2",children:["已选择 ",u.length,"/5 张图片","expense"===d.type&&0===u.length&&(0,s.jsx)("span",{className:"text-red-600 ml-2",children:"（支出申请必须上传至少1张）"})]}),(0,s.jsx)("div",{className:"space-y-2",children:u.map((e,t)=>(0,s.jsxs)("div",{className:"flex items-center justify-between bg-gray-50 p-2 rounded",children:[(0,s.jsx)("span",{className:"text-sm text-gray-700 truncate flex-1",children:e.name}),(0,s.jsx)("button",{type:"button",onClick:()=>g(t),className:"ml-2 text-red-600 hover:text-red-800",children:(0,s.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]},t))})]})]})]}),(0,s.jsxs)("div",{className:"flex justify-end space-x-3",children:[(0,s.jsx)("button",{type:"button",onClick:()=>e.push("/"),className:"px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50",children:"取消"}),(0,s.jsx)("button",{type:"submit",disabled:i,className:"px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed",children:i?"提交中...":"提交申请"})]})]})]})})})}},6319:function(e,t,r){"use strict";r.d(t,{Z:function(){return n}});var s=r(7437),a=r(2265),o=r(9376),l=r(9064);function n(e){let{children:t}=e,[r,n]=(0,a.useState)(null),[i,c]=(0,a.useState)(!1),d=(0,o.useRouter)();return((0,a.useEffect)(()=>{(()=>{let e=localStorage.getItem("auth-token"),t=localStorage.getItem("user");if(console.log("检查认证状态:",{hasToken:!!e,hasUser:!!t,currentPath:window.location.pathname}),!e||!t){console.log("未找到认证信息，跳转到登录页"),d.push("/login");return}try{let e=JSON.parse(t);console.log("用户数据解析成功:",e),n(e)}catch(e){console.error("用户数据解析失败:",e),localStorage.removeItem("auth-token"),localStorage.removeItem("user"),d.push("/login")}})()},[d]),r)?(0,s.jsxs)("div",{className:"min-h-screen bg-gray-50",children:[(0,s.jsx)("nav",{className:"bg-white shadow-md",children:(0,s.jsx)("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:(0,s.jsxs)("div",{className:"flex justify-between h-16",children:[(0,s.jsxs)("div",{className:"flex items-center",children:[(0,s.jsx)("button",{onClick:()=>d.push("/"),className:"text-xl font-bold text-gray-800 hover:text-gray-600",children:"班费管理系统"}),(0,s.jsx)("a",{href:"https://dashboard.pay.cubestudio.top",target:"_blank",rel:"noopener noreferrer",className:"ml-6 text-gray-600 hover:text-gray-900 px-3 py-2 rounded-md text-sm font-medium",children:"数据看板"})]}),(0,s.jsxs)("div",{className:"flex items-center space-x-4",children:["admin"===r.role&&(0,s.jsx)("button",{onClick:()=>d.push("/admin"),className:"text-gray-700 hover:text-gray-900 px-3 py-2 rounded-md text-sm font-medium",children:"管理后台"}),(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsxs)("button",{onClick:()=>c(!i),className:"flex items-center text-gray-700 hover:text-gray-900 px-3 py-2 rounded-md text-sm font-medium",children:[(0,s.jsx)("span",{className:"mr-2",children:r.real_name}),(0,s.jsx)("span",{className:"text-xs px-2 py-1 rounded ".concat("admin"===r.role?"bg-red-100 text-red-800":"bg-blue-100 text-blue-800"),children:"admin"===r.role?"管理员":"普通用户"}),(0,s.jsx)("svg",{className:"ml-2 h-4 w-4",fill:"currentColor",viewBox:"0 0 20 20",children:(0,s.jsx)("path",{fillRule:"evenodd",d:"M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z",clipRule:"evenodd"})})]}),i&&(0,s.jsxs)("div",{className:"absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50",children:[(0,s.jsx)("button",{onClick:()=>{c(!1),(0,l.Am)("个人资料功能开发中")},className:"block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 w-full text-left",children:"个人资料"}),(0,s.jsx)("button",{onClick:()=>{c(!1),d.push("/applications/new")},className:"block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 w-full text-left",children:"新建申请"}),(0,s.jsx)("hr",{className:"my-1"}),(0,s.jsx)("button",{onClick:()=>{localStorage.removeItem("auth-token"),localStorage.removeItem("user"),l.Am.success("已退出登录"),d.push("/login")},className:"block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 w-full text-left",children:"退出登录"})]})]})]})]})})}),(0,s.jsx)("main",{className:"max-w-7xl mx-auto py-6 sm:px-6 lg:px-8",children:t})]}):(0,s.jsx)("div",{children:"Loading..."})}},9376:function(e,t,r){"use strict";var s=r(5475);r.o(s,"useRouter")&&r.d(t,{useRouter:function(){return s.useRouter}})}},function(e){e.O(0,[64,971,117,744],function(){return e(e.s=8700)}),_N_E=e.O()}]);